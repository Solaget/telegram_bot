import { Telegraf, Markup } from "telegraf";
import express from "express";
import * as dotenv from "dotenv";

dotenv.config();

const BOT_TOKEN = process.env.BOT_TOKEN;
const PORT = process.env.PORT || 4040;

if (!BOT_TOKEN) {
  throw new Error("BOT_TOKEN is required in .env file");
}

const bot = new Telegraf(BOT_TOKEN);
const app = express();

// Command: /start
bot.start((ctx) => {
  ctx.reply(
    "Welcome! I am here to assist you. Type /help to see available commands."
  );
});

// Command: /help
bot.command("help", (ctx) => {
  ctx.reply(
    "Here are some commands you can use:\n/start - Start the bot\n/help - Show commands\n/menu - Show menu options"
  );
});

// Command: /menu
bot.command("menu", (ctx) => {
  ctx.reply(
    "Choose payment method",
    Markup.inlineKeyboard([
      Markup.button.callback("Telebirr", "OPTION_1"),
      Markup.button.callback("MPesa", "OPTION_2"),
      Markup.button.callback("Awash bank", "OPTION_3"),
      Markup.button.callback("Cbe", "OPTION_4"),
      Markup.button.callback("Abyssinia bank", "OPTION_5"),
    ])
  );
});

// Handle specific text with bot.hears
bot.hears("hello", (ctx) => {
  ctx.reply("Hello there! How can I assist you today?");
});

// Handle any other text with bot.on
bot.on("text", (ctx) => {
  ctx.reply(`You said: "${ctx.message.text}". I'm here to chat!`);
});

// Handle button clicks
bot.action("OPTION_1", (ctx) => {
  ctx.answerCbQuery();
  ctx.reply("You selected Option 1!");
});

bot.action("OPTION_2", (ctx) => {
  ctx.answerCbQuery();
  ctx.reply("You selected Option 2!");
});

bot.action("OPTION_3", (ctx) => {
  ctx.answerCbQuery();
  ctx.reply("You selected Option 3!");
});

bot.action("OPTION_4", (ctx) => {
  ctx.answerCbQuery();
  ctx.reply("You selected Option 3!");
});

bot.action("OPTION_5", (ctx) => {
  ctx.answerCbQuery();
  ctx.reply("You selected Option 3!");
});

// Set up the webhook endpoint
app.use(bot.webhookCallback("/bot"));

// Start the server and set the webhook dynamically
app.listen(PORT, async () => {
  console.log(`Server is running on port ${PORT}`);

  // Replace 'your-ngrok-url' with the actual URL generated by Ngrok
  const ngrokUrl = "https://86c0-196-191-61-96.ngrok-free.app";
  const webhookUrl = `${ngrokUrl}/bot`;

  try {
    await bot.telegram.setWebhook(webhookUrl);
    console.log(`Webhook set to ${webhookUrl}`);
  } catch (error) {
    console.error("Error setting webhook:", error);
  }
});
